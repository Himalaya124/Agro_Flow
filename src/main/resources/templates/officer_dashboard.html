<!-- officer_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AgroFlow â€“ Officer Dashboard</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
<!-- -------------  HEADER ------------- -->
<header class="bg-green-800 text-white flex justify-between items-center px-8 py-4 shadow-md">
    <div class="flex items-center space-x-4">
        <img src="/images/logo.jpg" class="w-12 rounded-lg" alt="logo"/>
        <div>
            <h1 class="text-2xl font-bold">AgroFlow</h1>
            <span class="text-sm opacity-80">Officer Dashboard</span>
        </div>
    </div>

    <div class="flex items-center space-x-4">
        <div class="text-right">
            <p class="font-semibold">Demo Officer</p>
            <p class="text-sm opacity-80">ID: OFF001</p>
        </div>
        <img src="/images/officer.jpg" class="w-10 h-10 rounded-full object-cover" alt="officer"/>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-800 text-white text-sm px-3 py-1 rounded">
            Logout
        </button>
    </div>
</header>

<!-- -------------  MAIN ------------- -->
<main class="flex-grow max-w-7xl mx-auto px-6 py-8 space-y-10">

    <!-- Stats -->
    <section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <h2 id="registeredFarmersCount" class="text-3xl font-extrabold text-green-700">0</h2>
            <p class="mt-2 font-semibold text-gray-700">Registered Farmers</p>
        </div>
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <h2 id="activePlansCount" class="text-3xl font-extrabold text-gray-700">0</h2>
            <p class="mt-2 font-semibold text-gray-700">Active Crop Plans</p>
        </div>
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <h2 id="pendingSalesCount" class="text-3xl font-extrabold text-orange-500">0</h2>
            <p class="mt-2 font-semibold text-gray-700">Pending Sales</p>
        </div>
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <h2 id="totalHarvestsCount" class="text-3xl font-extrabold text-blue-500">0</h2>
            <p class="mt-2 font-semibold text-gray-700">Total Harvests</p>
        </div>
    </section>

    <!-- Quick Actions -->
    <section>
        <h2 class="text-xl font-bold text-gray-800 mb-6">Quick Actions</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">

            <div id="register-farmer-btn"
                 class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition cursor-pointer border-l-4 border-green-600">
                <h3 class="text-lg font-semibold text-green-700 mb-2">Register New Farmer</h3>
                <p class="text-gray-600">Add a new farmer to the system</p>
            </div>

            <a href="registered_farmers.html"
               class="bg-white shadow rounded-lg p-6 border-l-4 border-gray-600 flex flex-col hover:shadow-lg transition no-underline">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">
                    Registered Farmers (<span id="registeredFarmersCountLink">0</span>)
                </h3>
                <p class="text-gray-600">View and manage registered farmers</p>
            </a>

            <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition cursor-pointer border-l-4 border-orange-500">
                <h3 class="text-lg font-semibold text-orange-600 mb-2">Statistics</h3>
                <p id="statsSummary" class="text-gray-600">Active Plans: 0 | Harvests: 0</p>
            </div>

            <a href="sales.html"
               class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition cursor-pointer border-l-4 border-blue-600">
                <h3 class="text-lg font-semibold text-blue-600 mb-2">Manage Sales</h3>
                <p class="text-gray-600">Process sales requests</p>
            </a>
        </div>
    </section>

    <!-- Market Prices -->
    <section>
        <h2 class="text-xl font-bold text-gray-800 mb-4">Market Prices</h2>
        <div class="bg-white shadow rounded-lg p-8 text-center text-gray-600">
            <a href="market-price.html">
                <button class="mt-6 px-6 py-2 bg-green-700 text-white rounded-md hover:bg-green-900 transition">
                    View Market Price
                </button>
            </a>
        </div>
    </section>
</main>

<!-- -------------  REGISTER FARMER MODAL ------------- -->
<div id="modal-bg" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

<div id="register-farmer-modal"
     class="fixed inset-0 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
        <button id="modal-close-btn"
                class="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-xl font-bold">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-green-700">Register New Farmer</h2>

        <form id="farmerForm" class="space-y-4">
            <input name="farmerId"  class="w-full px-3 py-2 border rounded" placeholder="Farmer ID"  required />
            <input name="name"      class="w-full px-3 py-2 border rounded" placeholder="Name"       required />
            <input name="nid"       class="w-full px-3 py-2 border rounded" placeholder="NID"        required />
            <input name="address"   class="w-full px-3 py-2 border rounded" placeholder="Address"    required />
            <input name="contactNo" class="w-full px-3 py-2 border rounded" placeholder="Contact No" required />

            <button type="submit"
                    class="w-full bg-green-700 text-white py-2 rounded hover:bg-green-900 transition">
                Register Farmer
            </button>
        </form>
    </div>
</div>

<!-- -------------  DASHBOARD SCRIPT ------------- -->
<script>
    const API_BASE   = 'http://localhost:8080/api/v1';
    const OFFICER_ID = 'OFF001';                   // swap with logged-in officer later

    /* ---------- Modal helpers ---------- */
    const registerBtn = document.getElementById('register-farmer-btn');
    const modal       = document.getElementById('register-farmer-modal');
    const modalBg     = document.getElementById('modal-bg');
    const closeBtn    = document.getElementById('modal-close-btn');

    registerBtn.addEventListener('click', () => { modal.classList.remove('hidden'); modalBg.classList.remove('hidden'); });
    const hideModal = () => { modal.classList.add('hidden'); modalBg.classList.add('hidden'); };
    closeBtn.addEventListener('click', hideModal);
    modalBg.addEventListener('click', hideModal);

    /* ---------- Count elements ---------- */
    const farmerCountEl       = document.getElementById('registeredFarmersCount');
    const farmerCountLinkEl   = document.getElementById('registeredFarmersCountLink');
    const activePlansEl       = document.getElementById('activePlansCount');
    const pendingSalesEl      = document.getElementById('pendingSalesCount');
    const totalHarvestsEl     = document.getElementById('totalHarvestsCount');
    const statsSummaryEl      = document.getElementById('statsSummary');

    /* ---------- Fetch & render dashboard stats ---------- */
    async function loadStats() {
        try {
            const res = await fetch(`${API_BASE}/officer/${OFFICER_ID}/dashboard`);
            if (!res.ok) throw new Error('Failed dashboard call');
            const s = await res.json();

            farmerCountEl.textContent     = s.registeredFarmers;
            farmerCountLinkEl.textContent = s.registeredFarmers;
            activePlansEl.textContent     = s.activePlans;
            pendingSalesEl.textContent    = s.pendingSales;
            totalHarvestsEl.textContent   = s.totalHarvests;
            statsSummaryEl.textContent    = `Active Plans: ${s.activePlans} | Harvests: ${s.totalHarvests}`;
        } catch (err) {
            console.error(err);
            // graceful fallback
        }
    }
    loadStats();                        // initial run

    /* ---------- Register farmer form ---------- */
    document.getElementById('farmerForm').addEventListener('submit', async e => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));

        try {
            const res = await fetch(`${API_BASE}/farmers`, {
                method : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body   : JSON.stringify(data)
            });

            if (res.status === 201) {
                await loadStats();            // refresh counts
                hideModal();
                e.target.reset();
            } else {
                const msg = await res.text();
                alert(msg || 'Unable to register farmer');
            }
        } catch (err) {
            alert('Network error');
        }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            await fetch('http://localhost:8080/logout', {
                method: 'POST',
                credentials: 'include'      // send JSESSIONID
            });
        } catch (_) {
            /* ignore network errors */
        } finally {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';   // or your login path
        }
    });
</script>
</body>
</html>
